# molecad

API для извлечения информации из баз данных Pubchem и дальнейшего взаимодействия с этими данными.

## Содержание

* [Документация на Confluence](#документация-на-confluence)
* [Настройка виртуального окружения](#настройка-виртуального-окружения)
* [Настройка переменных окружения](#настройка-переменных-окружения)
* [Использование консольной утилиты для скачивания свойств молекул из Pubchem](#использование-консольной-утилиты-для-скачивания-свойств-молекул-из-Pubchem)
* HOWTO
  * [Как развернуть MongoDB локально на macOS](#как-развернуть-mongodb-локально-на-macos)
    
* [Использование mongo-rdkit для подструктурного поиска по базе](#использование-mongo-rdkit-для-подструктурного-поиска-по-базе)
* [Схема базы данных](#схема-базы-данных)
* [Документация ручек API](#документация-ручек-api)
* [Структура проекта](#структура-проекта)


## Документация на Confluence

* [Как развернуть MongoDB локально на macOS](https://confluence.biocad.ru/x/3BhQCw)
* [Что можно скачать из баз данных PubChem](https://confluence.biocad.ru/x/DwpQCw)
* [Как использовать molecad для скачивания данных из Pubchem](https://confluence.biocad.ru/x/_ixQCw)
* [Описание ручек api](https://confluence.biocad.ru/x/jCxQCw)


## Настройка виртуального окружения

> Перед тем как приступить к настройке виртуального окружения, убедитесь, что на вашем компьютере 
> установлены [pyenv](https://github.com/pyenv/pyenv-installer) и [poetry](https://python-poetry.org/docs/), 
> причем их пути должны быть добавлены в `PATH`.

Склонируйте [репозиторий](https://github.com/vvrubel/molecad) и запустите shell из директории, 
содержащей файл `pyproject.toml`.

В проекте используется Python версии 3.7.10, который вы можете установить, используя `pyenv`:

```shell
$ pyenv install 3.7.10
$ pyenv local 3.7.10
```

Создать виртуальное окружение и установить все зависимости проекта можно с помощью `poetry`:

```shell
$ poetry install
```

Вуаля! Все зависимости проекта установлены и никакой конды, вам не потребовалось.  
Подробнее о реализации пути через `conda` можно почитать [тут](https://confluence.biocad.ru/x/vi1QCw).


## Настройка переменных окружения

После настройки виртуальной среды, необходимо задать переменные окружения – это параметры для подключения к mongodb и запуска скрипта, выполняющего запросы к базам данных Pubchem.  
Удобнее всего установить переменные один раз, создав файл `.env` из шаблона `.env.sample`. 

В корневой директории найдите файл `.env.sample`, скопируйте его, заполните недостающие поля и переименуйте файл в `.env`.

Переменные окружения в файле `.env` могут быть двух типов: имеющие значение по умолчанию и не 
имеющие его. Если переменная имеет значение по умолчанию, то оно указано в таблице ниже. 
Переменные не имеющие значений по умолчанию обязательны к первоначальной настройке.

Переменная|Описание
---|---
MONGO_HOST|Хост базы данных MongoDB; по умолчанию -> `"127.0.0.1"`  
MONGO_PORT|Порт базы данных MongoDB; по умолчанию -> `27017`  
MONGO_USER|Имя пользователя базы данных MongoDB  
MONGO_PASSWORD|Пароль пользователя базы данных MongoDB  
MONGO_DB_NAME|Название базы данных, к которой будет подключаться пользователь; по умолчанию -> `"molecad"`  
MONGO_DB_COLLECTION|Название коллекции, в которой хранятся данные о свойствах молекул из базы данных `Compound`, скачанные с серверов Pubchem; по умолчанию -> `"molprops"` 
PROJ_DIR|Путь до корневой директории проекта, если значение не определено, то будет использоваться текущая директория; по умолчанию -> `.`
FETCH_DIR|Шаблон именования пути до директорий для сохранения файлов, полученных от серверов Pubchem с помощью команды `fetch`; по умолчанию -> `./data/fetch`
SPLIT_DIR|Шаблон именования пути до директорий для сохранения файлов, полученных в результате выполнения команды `split` над json-файлами; по умолчанию -> `./data/split`

## Использование консольной утилиты для скачивания свойств молекул из Pubchem

Данный проект предоставляет доступ к консольной утилите для извлечения информации о свойствах молекул с серверов Pubchem, сохранения полученных данных в файлы формата JSON, а также загрузки содержимого в базу данных MongoDB. 

Справка по работе утилиты:

```shell
$ poetry run python -m molecad.data.console __main__ --help                      

Usage: python -m molecad.data.console [OPTIONS] COMMAND [ARGS]...

  Консольная утилита для извлечения информации о свойствах молекул с серверов
  Pubchem, сохранения полученных данных в файлы формата JSON, а также загрузки
  содержимого в базу данных MongoDB.

Options:
  --help  Show this message and exit.

Commands:
  fetch     Извлекает и сохраняет информацию из базы данных Pubchem –...
  populate  Загружает chunked-файлы из указанной директории в локальную...
  split     Разрезает большой JSON на чанки меньшего размера для...
```


При скачивании данных с серверов Pubchem с помощью команды `fetch` консольной утилиты, 
программа не ждет пока выполнятся все запросы для того, чтобы сохранить все данные в файл, 
а пишет результаты по мере выполнения.  

В ходе работы команды `fetch` создается поддиректория, называемая в соответствие с 
параметрами `start` и `stop`, в директории `./data/fetch/`; в созданную поддиректорию 
сохраняются файлы, имеющие названия, составленные из крайних значений диапазонов идентификаторов 
сохраняемого файла. Размер диапазона задается при вызове команды `fetch` с опцией `--f-size`. 

Так как MongoDB имеет ограничение на количество создаваемых документов при разовой загрузке в базу 
из файла, то дальнейший план будет определяться длинной списка, который находится в этом файле. 
Если длина списка (число запрошенных идентификаторов) < 100000, то этот файл можно сразу загрузить 
в локальную базу данных MongoDB, используя команду `populate`. Иначе перед загрузкой потребуется 
его разделение на chunked-файлы меньшего размера с помощью команды `split`, например по 1000 
идентификаторов в файле.

> Запуск команд утилиты рекомендуется производить из корневой директории проекта.

Справка по команде `fetch`:  
```shell
$ poetry run python -m molecad.data.console fetch --help                                                                                                        
Usage: python -m molecad.data.console fetch [OPTIONS]

  Извлекает и сохраняет информацию из базы данных Pubchem – 'Compound'. Для
  совершения запроса к серверу необходимо уточнить диапазон идентификаторов
  интересуемых соединений - 'CID'. Данные извлекаются путем отправления
  запроса на сгенерированный URL. Из-за ограничения на количество символов
  в строке URL, отправка запроса, включающего все желаемые идентификаторы,
  может привести к ошибке, поэтому рекомендуется использовать опцию `--url-
  size`, которая по умолчанию равна `100`. Полученные данные сохраняются в
  файл, причем имеется возможность сохранять файл порциями до окончания
  работы программы, указав в качестве опции `--f-size` желаемое количество
  идентификаторов в сохраняемом файле, которое по умолчанию равна `1000`.

Options:
  --start INTEGER     Первое значение из запрашиваемых CID.  [required]
  --stop INTEGER      Последнее значение из запрашиваемых CID.  [required]
  --url-size INTEGER  Максимальное число идентификаторов в одном запросе,
                      по умолчанию равно 100.  [default: 100]
  --f-size INTEGER    Максимальное число идентификаторов в сохраняемом
                      файле, по умолчанию равно 1000.  [default: 1000]
  --help              Show this message and exit.
```

Справка по команде `populate`:

```shell
$ poetry run python -m molecad.data.console populate --help                                                                                                   
Usage: python -m molecad.data.console populate [OPTIONS]

  Загружает содержимое файлов из указанной директории в коллекцию базы
  данных 'molecad' с помощью `db.collection.insert_many({..})`. MongoDB
  имеет ограничение на количество документов, загружаемых таким образом за
  один раз, которое равно 100000 документов. Если документ, который вы
  желаете загрузить имеет больший размер, то перед загрузкой в базу
  разделите его на части с помощью команды `split`

Options:
  --file_dir PATH    Путь до директории, содержащей chunked-файлы, каждый
                     из которых представляет собой список, длинной до
                     100000 элементов.  [required]
  --collection TEXT  Название коллекции MongoDB, в которую будут загружены
                     файлы.  [required]
  --help             Show this message and exit.
```

Справка по команде `split`:

```shell
$ poetry run python -m molecad.data.console split --help

Usage: python -m molecad.data.console split [OPTIONS]

  При использовании команды `db.collection.insert_many({..})` имеется
  ограничение на максимально допустимое количество добавляемых документов
  за один раз равное 100000. Данная функция служит для того, чтобы
  разрезать JSON-файлы, превышающие указанное выше ограничение, на файлы
  меньшего размера.

Options:
  --file PATH       Файл не подходящий под критерии загрузки файлов в
                    MongoDB.  [required]
  --f-size INTEGER  Максимальное число идентификаторов в сохраняемом файле,
                    по умолчанию равно 1000.  [default: 1000]
  --help            Show this message and exit.
```

## Использование mongo-rdkit для подструктурного поиска по базе

Исторически сложилось, что `mongo-rdkit` и просто `rdkit` используют виртуальное окружение 
`conda` для разрешения своих зависимостей.  Но в данном проекте было решено реализовать 
управление зависимостями этих библиотек с использованием `poetry`.  
Если вы хотите использовать окружение конды и вам хочется узнать, как установить `conda` рядом с 
`pyenv` наиболее безболезненно – читайте [тут](https://confluence.biocad.ru/x/vi1QCw).  

После того как мы настроили окружение, его переменные, развернули MongoDB и загрузили все 
скачанные данные в локальную базу – можно приступать к рассмотрению задачи о подструктурном 
поиске. Перед этим нужно отметить несколько ключевых моментов:

* так как поиск будет производиться по smiles молекул, то каждый документ должен содержать поле 
  `CanonicalSMILES`. Таким образом, все документы, которые не имеют данного поля, должны быть 
  удалены. Пример того, как это можно сделать через консоль, авторизовавшись на сервере mongod.
  
```shell
MongoDB Enterprise > db.molecules.find({"CanonicalSMILES": { $exists: false }}).count()
37

MongoDB Enterprise > db.molecules.deleteMany({"CanonicalSMILES": { $exists: false }})
{ "acknowledged" : true, "deletedCount" : 37 }
```


## HOWTO

### Как развернуть MongoDB локально на macOS

Установите на свой компьютер сервер MongoDB: Community Server можно поставить с помощью 
менеджера пакетов для macOS - `brew`, а Enterprise Server - из архива `.targz`. Добавьте путь до 
исполняемого файла в `PATH`.  

Ниже описаны основные шаги разворачивания локальной базы на примере Enterprise Server. Детальное 
описание процесса установки и инструкции для Community Server можно найти по [ссылке](https://confluence.biocad.ru/x/3BhQCw).

Переходим в каталог с только что установленным сервером MongoDB и создаем в нем подкаталог для 
локальной базы, после чего запустим сервер.

```shell
$ mkdir -p ./data/db
$ mongod --dbpath ./data/db
```

После того как сервер запущен, подключаемся к локальной базе данных. При первом запуске базы необходимо создать пользователей.  

Пример кода для создания суперпользователя: 

```shell
$ mongo
MongoDB Enterprise> use admin
MongoDB Enterprise> db.createUser({ user: "superuser", pwd: "<pwd>", roles: [ "root" ] })
```

После того как пользователь будет создан, нужно выключить сервер и выйти в исходный shell.

```shell
MongoDB Enterprise> db.shutdownServer()
MongoDB Enterprise> exit
```

Теперь перезапускаем сервер mongod, но с параметром `--auth` для подключения по логину-паролю. 
Готово! Теперь вы можете использовать свою базу.

```shell
$ mongod --dbpath ./data/db --auth
$ mongo mongodb://superuser:<password>@127.0.0.1:27017/admin
```

## Схема базы данных
```
    CID: int
    MolecularFormula: str
    MolecularWeight: Union[float, str]  # почему-то в response приходит строка
    CanonicalSMILES: str
    InChI: str
    IUPACName: str
    XLogP: float
    HBondDonorCount: int
    HBondAcceptorCount: int
    RotatableBondCount: int
    AtomStereoCount: int
    BondStereoCount: int
    Volume3D: Union[float, int]
```
## Документация ручек API